<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"  
integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
  <!-- Bootstrap Table -->
  <link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.21.2/dist/bootstrap-table.min.css">
  <!-- our own css -->
  <link rel="stylesheet" href="/static/css/address_book.css">
  <!-- Scripts with defer for parallel download and proper execution order -->
  <script defer src="https://code.jquery.com/jquery-3.5.0.js"></script>
  <script defer src="https://unpkg.com/bootstrap-table@1.21.2/dist/bootstrap-table.min.js"></script>
</head>

<body>
  <h1>Address Book</h1>
  <h2>Add a Contact:</h2>
  <div class="container">
    <form id="addContactForm">
      <div class=box1>
        <label for="firstname">ชื่อ</label>
        <input type="text" id="firstname" name="firstname" placeholder="Your name.." required>
      </div>
      <div class=box2>
        <label for="lastname">นามสกุล</label>
        <input type="text" id="lastname" name="lastname" placeholder="Your last name.." required>
      </div>
      <div class=box1>
        <label for="phone">โทรศัพท์</label>
        <input type="tel" id="phone" name="phone"  placeholder="Your phone number.." required>
      </div>
      <div class=box2>
        <label for="postcode">รหัสไปรษณีย์</label>
        <input type="text" id="postcode" name="postcode" placeholder="Your postcode.." required>
      </div>
      <label for="subdist">ตำบล/แขวง</label>
      <select class="greyed" id="subdist" name="subdist" disabled required>
        <option value="">Please Select..</option>
      </select>
      <div class=box1>
        <label for="district">อำเภอ/เขต</label>
        <input type="text" id="district" name="district" placeholder="Your district.." disabled required>
      </div>
      <div class=box2>
        <label for="province">จังหวัด</label>
        <input type="text" id="province" name="province" placeholder="Your province.." disabled required>
      </div>
      <input type="submit" name="submit" value="Submit">
    </form>
  </div>
  <h2>Contacts:</h2>
  <table class="table-striped border-success" id="contact-table">
    <thead>
      <tr>
        <th data-field="firstname">
          <span class="text-success">
            ชื่อ
          </span>
        </th>
        <th data-field="lastname">
          <span class="text-success">
            นามสกุล
          </span>
        </th>
        <th data-field="phone">
          <span class="text-success">
            โทรศัพท์
          </span>
        </th>
        <th data-field="subdist">
          <span class="text-success">
            ตำบล/แขวง
          </span>
        </th>
        <th data-field="district">
          <span class="text-success">
            อำเภอ/เขต
          </span>
        </th>
        <th data-field="province">
          <span class="text-success">
            จังหวัด
          </span>
        </th>
        <th data-field="postcode">
          <span class="text-success">
            รหัสไปรษณีย์
          </span>
        </th>
      </tr>
    </thead>
  </table>
</body>

  <script>
    function populate_table(contact_data) {
      console.log(contact_data);
      $('#contact-table').bootstrapTable({
        data: contact_data
      });
    }

    function refresh_table(contact_data) {
      $('#contact-table').bootstrapTable('load', contact_data);
    }

    async function submitContact(formData, formAction) {
      try {
        // Add disabled field values manually
        const provinceInput = document.querySelector('#province');
        const districtInput = document.querySelector('#district');

        if (provinceInput.value) {
            formData.province = provinceInput.value;
        }
        if (districtInput.value) {
            formData.district = districtInput.value;
        }

        const url = formAction || window.location.href;
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams(formData).toString()
        });
        const contact_data = await response.json();
        refresh_table(contact_data);
        return true;
      } catch (error) {
        console.error('Error submitting form:', error);
        return false;
      }
    }

    // Function to reset form
    function resetContactForm() {
      const form = document.querySelector('#addContactForm');
      const subdistSelect = document.querySelector('#subdist');
 
      form.reset();
      
      // Remove all options except the first one
      const firstOption = subdistSelect.options[0];
      subdistSelect.innerHTML = '';
      subdistSelect.appendChild(firstOption);

      // Disable and remove active class
      subdistSelect.disabled = true;
      subdistSelect.classList.remove('greyed_active');
    }

    async function loadContacts() {
      try {
        const response = await fetch('lab09/contacts');
        const data = await response.json();
        populate_table(data);
      } catch (error) {
        console.error('Error loading contacts:', error);
      }
    }

    async function fetchSubdistList(postcode) {
      try {
        const query = new URLSearchParams({ postcode: postcode });
        const response = await fetch(`lab09/subdist_list?${query}`);
        const content = await response.json();
        return content;
      } catch (error) {
        console.error('Error fetching subdist list:', error);
        return [];
      }
    }

    function renderSubdistOptions(content) {
      const subdistSelect = document.querySelector('#subdist');
      const provinceInput = document.querySelector('#province');
      const districtInput = document.querySelector('#district');


      // Clear existing values
      provinceInput.value = '';
      districtInput.value = '';


      // Remove all options from subdist except the first one
      const firstOption = subdistSelect.options[0];
      subdistSelect.innerHTML = '';
      subdistSelect.appendChild(firstOption);


      // Add new options
      content.forEach((p, i) => {
        if (i === 0) {
          provinceInput.value = p[0];
          districtInput.value = p[1];
        }
        const option = document.createElement('option');
        option.value = p[2];
        option.textContent = p[2];
        subdistSelect.appendChild(option);
      });


      // Enable subdist select
      subdistSelect.disabled = false;
      subdistSelect.classList.add('greyed_active');
    }

    document.addEventListener('DOMContentLoaded', function () {
      // Load initial contacts
      loadContacts();
    });

    // Handle form submission
    const form = document.querySelector('#addContactForm');
    form.addEventListener('submit', async function (event) {
      event.preventDefault();

      // Collect form data
      const formData = new FormData(this);
      const data = {};

      for (const [key, value] of formData.entries()) {
        if (key !== 'submit') {
          data[key] = value;
        }
      }

      // Submit and reset form on success
      const formAction = this.getAttribute('action');
      const success = await submitContact(data, formAction);
      if (success) {
        resetContactForm();
      }
    });

      // Handle postcode change
      const postcodeInput = document.querySelector('#postcode');
      postcodeInput.addEventListener('change', async function (e) {
        const postcode = this.value;
        if (postcode) {
          const content = await fetchSubdistList(postcode);
          console.log(content);
          renderSubdistOptions(content);
        }
      });

  </script>
</html>

